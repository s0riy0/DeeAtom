<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>ATOM INDUSTRY - ‡∏ï‡∏•‡∏≤‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
      .post-form {
        background-color: #f9f9f9;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
        border: 1px solid #e0e0e0;
      }
      .form-row {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
      }
      .form-row input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      .post-btn {
        background-color: #007bff;
        color: #fff;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        width: 100%;
      }
      .my-post-status {
        margin-top: 20px;
        padding: 15px;
        background-color: #e9ecef;
        border-radius: 5px;
      }
      .status-tag {
        padding: 3px 8px;
        border-radius: 12px;
        color: #fff;
        font-size: 0.8em;
      }
      .status-pending {
        background-color: #ffc107;
      }
      .status-approved {
        background-color: #28a745;
      }
      .status-rejected {
        background-color: #dc3545;
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.5);
      }
      .modal-content {
        background-color: #fff;
        margin: 10% auto;
        padding: 25px;
        border: 1px solid #888;
        width: 90%;
        max-width: 450px;
        border-radius: 8px;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        margin: 0;
      }
      .close-btn {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: 700;
        cursor: pointer;
      }
      .close-btn:hover,
      .close-btn:focus {
        color: #000;
        text-decoration: none;
        cursor: pointer;
      }
      .modal-content label {
        display: block;
        margin-top: 15px;
        margin-bottom: 5px;
        font-weight: bold;
      }
      .modal-content input {
        width: 100%;
        padding: 8px;
        box-sizing: border-box;
      }
      #qr-code-container {
        text-align: center;
        margin-bottom: 20px;
      }
      #qr-code-container img {
        max-width: 200px;
        border: 1px solid #ddd;
        padding: 5px;
        border-radius: 5px;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="sidebar-logo">
        <img src="ChatGPT Image 21 ‡∏°‡∏¥.‡∏¢. 2568 10_23_59.png" class="logo" /><img
          src="DeeCoin.png"
          class="dee-logo"
        />
      </div>
      <div class="user-bar">
        <span class="user-icon">üë§</span>
        <span class="realname" id="name">Loading...</span
        ><button id="logoutBtn">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        <option>‡πÑ‡∏ó‡∏¢</option>
      </div>
    </header>
    <nav class="sidebar">
      <a href="index.html">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a><a href="account.html">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</a
      ><a href="All_id.html">- ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</a
      ><a href="add-account.html">- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</a
      ><a href="wallet.html">‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô</a
      ><a href="account-list.html">- ‡∏ï‡∏•‡∏≤‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢</a
      ><a href="withdraw.html">- ‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</a
      ><a href="transaction-history.html">- ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏≥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</a
      ><a href="mining-game.html">‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡πÄ‡∏Å‡∏°‡∏™‡πå</a
      ><a href="other-games.html">- ‡πÄ‡∏Å‡∏°‡∏™‡πå‡∏≠‡∏∑‡πà‡∏ô‡πÜ</a
      ><a href="profile.html">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</a
      ><a href="profile.html">- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</a
      ><a href="setting.html">- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</a
      ><a href="bank-card.html">- Bank card</a
      ><a href="join.html">‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô‡∏Å‡∏±‡∏ö‡πÄ‡∏£‡∏≤</a>
    </nav>

    <main class="main-list">
      <div class="post-form">
        <h3>‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Ç‡∏≤‡∏¢‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç DeeCoin</h3>
        <form id="sellPostForm">
          <div class="form-row">
            <input
              type="number"
              id="deeCoinAmount"
              placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô DeeCoin"
              step="any"
              required
            /><input
              type="number"
              id="thbAmount"
              placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤ THB"
              step="any"
              required
            />
          </div>
          <button type="submit" class="post-btn" id="postSubmitBtn">
            ‡∏™‡πà‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
          </button>
        </form>
        <div
          class="my-post-status"
          id="myPostStatusContainer"
          style="display: none"
        ></div>
      </div>

      <div class="page-title" style="font-size: 1.3em">‡∏ï‡∏•‡∏≤‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢</div>
      <div class="score-table">
        <table>
          <thead>
            <tr>
              <th>‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢</th>
              <th>DEE</th>
              <th>THB</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="marketTableBody"></tbody>
        </table>
      </div>
    </main>

    <div id="buyModal" class="modal">
      <div class="modal-content">
        <span id="closeBuyModal" class="close-btn">&times;</span>
        <h3>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠</h3>

        <div id="qr-code-container">
          <p><strong>‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</strong></p>
          <img src="payment.jpg" alt="QR Code for Payment" />
        </div>

        <form id="buyForm">
          <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞ (‡∏ö‡∏≤‡∏ó)</label>
          <input
            type="number"
            id="amount-display"
            disabled
            style="background-color: #eee; font-weight: bold"
          />
          <label for="keybag-input">‡πÄ‡∏•‡∏Ç‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏ï‡∏±‡∏á‡∏Ñ‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</label>
          <input
            type="text"
            id="keybag-input"
            placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏ï‡∏±‡∏á‡∏Ñ‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô"
            required
          />
          <label for="slipUpload">‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏ö‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
          <input type="file" id="slipUpload" accept="image/*" required />
          <button
            type="submit"
            id="confirmBuyBtn"
            class="post-btn"
            style="margin-top: 20px"
          >
            ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
          </button>
        </form>
      </div>
    </div>

    <footer class="footer-account">
      <div class="android-row">
        <span>android</span>
        <img
          src="android-icon-logo-png_seeklogo-306470.png"
          class="android-icon"
          alt="android"
        />
        <img src="frame.png" class="qr-icon" alt="qr code" />
      </div>

      <div class="flag-row">
        <div class="lang-row">
          <img
            src="istockphoto-1032082612-612x612.jpg"
            alt="Thai Flag"
            class="flag"
          />
          <span class="lang-text">‡πÑ‡∏ó‡∏¢</span>
        </div>
      </div>

      <div class="side-social">
        <a href="https://www.facebook.com/profile.php?id=61579275875237"
          ><img src="Facbook.jpg" alt="Facebook"
        /></a>
        <a href="https://lin.ee/RJo5SD2"><img src="Line.jpg" alt="Line" /></a>
      </div>
    </footer>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
      import {
        getDatabase,
        ref,
        onValue,
        get,
        push,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
      import {
        getFunctions,
        httpsCallable,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-functions.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCmrCEiO2kVl5j3VlwPycOYABoEiA0Kkts",
        authDomain: "kudthong-f67a2.firebaseapp.com",
        databaseURL:
          "https://kudthong-f67a2-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "kudthong-f67a2",
        storageBucket: "kudthong-f67a2.appspot.com",
        messagingSenderId: "140418020508",
        appId: "1:140418020508:web:1d2feb2b7b1bd9ea0ee959",
      };
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const database = getDatabase(app);
      const functions = getFunctions(app, "asia-southeast1");
      let currentUser = null;
      let currentItemToBuy = null;

      onAuthStateChanged(auth, (user) => {
        if (user) {
          currentUser = user;
          const userProfileRef = ref(
            database,
            "usersID/" + user.uid + "/profile"
          );
          onValue(userProfileRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
              document.getElementById("name").innerText =
                data.realName || data.nickname || user.email;
            }
          });
          loadMarketItems();
          checkMyPostStatus(user.uid);
        } else {
          window.location.href = "./login.html";
        }
      });

      document
        .getElementById("sellPostForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const deeCoin = parseFloat(
            document.getElementById("deeCoinAmount").value
          );
          const thb = parseFloat(document.getElementById("thbAmount").value);
          const userProfileRef = ref(
            database,
            `usersID/${currentUser.uid}/profile`
          );
          const snapshot = await get(userProfileRef);
          const currentDeeCoin = snapshot.val().DeeCoin || 0;
          if (deeCoin > currentDeeCoin) {
            alert("‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ DeeCoin ‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Ç‡∏≤‡∏¢");
            return;
          }
          const postData = {
            userId: currentUser.uid,
            userEmail: currentUser.email,
            deeCoinAmount: deeCoin,
            thbAmount: thb,
            status: "pending",
            timestamp: serverTimestamp(),
          };
          const postRequestsRef = ref(database, "sellPostRequests");
          await push(postRequestsRef, postData);
          alert("‡∏™‡πà‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß");
          document.getElementById("sellPostForm").reset();
        });
      
      // --- üü¢ ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ---
      function loadMarketItems() {
        const marketRef = ref(database, "marketItems");
        const tableBody = document.getElementById("marketTableBody");
        onValue(marketRef, (snapshot) => {
          tableBody.innerHTML = "";
          if (snapshot.exists()) {
            snapshot.forEach((child) => {
              const itemId = child.key;
              const item = child.val();
              const row = document.createElement("tr");
              
              let actionCellHtml = '';

              // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
              if (item.userId === currentUser.uid) {
                // ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πà ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
                actionCellHtml = `<td><button disabled style="padding:5px 10px; cursor:not-allowed; background-color:#ccc;">‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</button></td>`;
              } else {
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° "‡∏ã‡∏∑‡πâ‡∏≠"
                actionCellHtml = `<td><button class="buy-btn" data-item-id="${itemId}" style="padding:5px 10px; cursor:pointer;">‡∏ã‡∏∑‡πâ‡∏≠</button></td>`;
              }
              
              row.innerHTML = `<td>${item.userEmail.split("@")[0]}...</td>
                             <td>${item.deeCoinAmount.toFixed(4)}</td>
                             <td>${item.thbAmount.toFixed(2)}</td>
                             ${actionCellHtml}`; // ‡∏ô‡∏≥ action cell ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏°‡∏≤‡πÉ‡∏™‡πà

              tableBody.appendChild(row);
            });
          } else {
            tableBody.innerHTML =
              '<tr><td colspan="4" style="text-align:center;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÉ‡∏ô‡∏ï‡∏•‡∏≤‡∏î</td></tr>';
          }
        });
      }
      // --- üü¢ ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ---

      function checkMyPostStatus(userId) {
        /* ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° */
      }

      const modal = document.getElementById("buyModal");
      document.getElementById("closeBuyModal").onclick = () => {
        modal.style.display = "none";
      };
      window.onclick = (event) => {
        if (event.target == modal) {
          modal.style.display = "none";
        }
      };

      document
        .getElementById("marketTableBody")
        .addEventListener("click", async (e) => {
          if (e.target.classList.contains("buy-btn")) {
            const itemId = e.target.dataset.itemId;
            const itemRef = ref(database, `marketItems/${itemId}`);
            const snapshot = await get(itemRef);
            if (snapshot.exists()) {
              currentItemToBuy = { id: itemId, ...snapshot.val() };
              document.getElementById("amount-display").value =
                currentItemToBuy.thbAmount.toFixed(2);
              modal.style.display = "block";
            } else {
              alert("‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏ï‡∏•‡∏≤‡∏î");
            }
          }
        });

      document
        .getElementById("buyForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          if (!currentItemToBuy) return;

          const keybagInput = document.getElementById("keybag-input").value;
          const slipFile = document.getElementById("slipUpload").files[0];

          if (!slipFile) {
            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏ö‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠");
            return;
          }

          const buyerProfileRef = ref(database, `usersID/${currentUser.uid}/profile`);
          const snapshot = await get(buyerProfileRef);
          if (snapshot.val().KeyBag !== keybagInput) {
            alert("‡πÄ‡∏•‡∏Ç‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏ï‡∏±‡∏á‡∏Ñ‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!");
            return;
          }

          const confirmBtn = document.getElementById("confirmBuyBtn");
          confirmBtn.disabled = true;
          confirmBtn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...";

          try {
            const getBase64 = (file) => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = (error) => reject(error);
            });

            const slipBase64 = await getBase64(slipFile);

            const purchaseData = {
              itemId: currentItemToBuy.id,
              sellerId: currentItemToBuy.userId,
              buyerId: currentUser.uid,
              buyerEmail: currentUser.email,
              thbAmount: currentItemToBuy.thbAmount,
              deeCoinAmount: currentItemToBuy.deeCoinAmount,
            };

            const sendRequest = httpsCallable(functions, "sendPurchaseRequestWithSlip");
            const result = await sendRequest({
              purchaseData: purchaseData,
              slipBase64: slipBase64,
              slipFileType: slipFile.type
            });
            
            alert(result.data.message);
            
            modal.style.display = "none";
            e.target.reset();

          } catch (error) {
            console.error("Purchase Error:", error);
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
          } finally {
            confirmBtn.disabled = false;
            confirmBtn.innerText = "‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠";
          }
        });

      document
        .getElementById("logoutBtn")
        .addEventListener("click", () =>
          signOut(auth).then(() => (window.location.href = "./login.html"))
        );
    </script>
  </body>
</html>