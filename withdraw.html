<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>ATOM INDUSTRY - ‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
      .withdraw-form {
        background: #fff;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        margin-bottom: 30px;
      }
      .form-group {
        margin-bottom: 15px;
      }
      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #555;
      }
      .form-group label.required::after {
        content: " *";
        color: red;
      }
      .form-group input[type="text"],
      .form-group input[type="number"] {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
      }
      .form-group input[readonly] {
        background-color: #f0f0f0;
        cursor: not-allowed;
      }
      .account-table {
        margin-top: 20px;
      }
      .account-table table {
        width: 100%;
        border-collapse: collapse;
      }
      .account-table th,
      .account-table td {
        border: 1px solid #ddd;
        padding: 12px;
        text-align: left;
      }
      .account-table th {
        background-color: #34495e;
        color: white;
      }
      .withdraw-btn {
        background-color: #27ae60;
        color: white;
        padding: 12px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
        width: 100%;
        transition: background-color 0.3s;
      }
      .withdraw-btn:hover {
        background-color: #229954;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="sidebar-logo">
        <img
          src="ChatGPT Image 21 ‡∏°‡∏¥.‡∏¢. 2568 10_23_59.png"
          alt="Atom Industry"
          class="logo"
        />
        <img src="DeeCoin.png" alt="DEE" class="dee-logo" />
      </div>
      <div class="user-bar">
        <span class="user-icon">üë§</span>
        <span class="realname" id="name">Loading...</span>
        <button id="logoutBtn">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        <option>‡πÑ‡∏ó‡∏¢</option>
      </div>
    </header>

    <nav class="sidebar">
      <a href="index.html">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
      <a href="account.html">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</a>
      <a href="All_id.html">- ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</a>
      <a href="add-account.html">- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</a>
      <a href="wallet.html">‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô</a>
      <a href="account-list.html">- ‡∏ï‡∏•‡∏≤‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢</a>
      <a href="withdraw.html">- ‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</a>
      <a href="transaction-history.html">- ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏≥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</a>
      <a href="mining-game.html">‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡πÄ‡∏Å‡∏°‡∏™‡πå</a>
      <a href="other-games.html">- ‡πÄ‡∏Å‡∏°‡∏™‡πå‡∏≠‡∏∑‡πà‡∏ô‡πÜ</a>
      <a href="profile.html">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</a>
      <a href="profile.html">- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</a>
      <a href="setting.html">- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</a>
      <a href="bank-card.html">- Bank card</a>
      <a href="join.html">‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô‡∏Å‡∏±‡∏ö‡πÄ‡∏£‡∏≤</a>
    </nav>

    <main class="main-withdraw">
      <div class="page-title">‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</div>
      <form class="withdraw-form" id="withdrawForm">
        <div class="form-group">
          <label for="account" class="required">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
          <input
            type="text"
            id="accountBalance"
            value="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î..."
            readonly
          />
        </div>
        <div class="form-group">
          <label for="channel" class="required">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô</label>
          <input type="text" id="channel" value="‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô THB" readonly />
        </div>
        <div class="form-group">
          <label for="withdrawer" class="required">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡∏ñ‡∏≠‡∏ô</label>
          <input type="text" id="withdrawer" value="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î..." readonly />
        </div>
        <div class="form-group">
          <label for="withdraw-amount" class="required"
            >‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏≠‡∏ô THB</label
          >
          <input
            type="number"
            id="withdraw-amount"
            placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô"
            required
          />
        </div>
        <button type="submit" class="withdraw-btn">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</button>
      </form>
      <div class="account-table">
        <table>
          <thead>
            <tr>
              <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</th>
              <th>‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏• (‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©)</th>
              <th>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</th>
              <th>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</th>
              <th>‡∏™‡∏≤‡∏Ç‡∏≤</th>
              <th>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</th>
            </tr>
          </thead>
          <tbody id="bankInfoBody">
            <tr>
              <td colspan="6" style="text-align: center">
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </main>

    <footer class="footer-withdraw"></footer>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
      import {
        getDatabase,
        ref,
        onValue,
        get,
        update,
        push,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCmrCEiO2kVl5j3VlwPycOYABoEiA0Kkts",
        authDomain: "kudthong-f67a2.firebaseapp.com",
        databaseURL:
          "https://kudthong-f67a2-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "kudthong-f67a2",
        storageBucket: "kudthong-f67a2.appspot.com",
        messagingSenderId: "140418020508",
        appId: "1:140418020508:web:1d2feb2b7b1bd9ea0ee959",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const database = getDatabase(app);

      let currentUser = null;
      let userProfile = null;
      let userBankInfo = null;

      onAuthStateChanged(auth, (user) => {
        if (user) {
          currentUser = user;
          const userRef = ref(database, "usersID/" + user.uid);
          onValue(userRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
              userProfile = data.profile;
              userBankInfo = data.bankCardInfo;
              updateUI();
            }
          });
        } else {
          window.location.href = "login.html";
        }
      });

      function updateUI() {
        if (userProfile) {
          document.getElementById("name").innerText =
            userProfile.realName || userProfile.nickname || currentUser.email;
          document.getElementById(
            "accountBalance"
          ).value = `‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô THB ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ : ${
            userProfile.THBwallet || 0
          } THB`;
          document.getElementById("withdrawer").value = `‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô THB - ${
            userProfile.realName || "N/A"
          }`;
        }
        if (userBankInfo) {
          const bankTableBody = document.getElementById("bankInfoBody");
          bankTableBody.innerHTML = `
                    <tr>
                        <td>${userBankInfo.accountNameTh || "N/A"}</td>
                        <td>${userBankInfo.accountNameEn || "N/A"}</td>
                        <td>${
                          userBankInfo.accountNumber
                            ? "xxx-x-" + userBankInfo.accountNumber.slice(-5)
                            : "N/A"
                        }</td>
                        <td>${userBankInfo.bankName || "N/A"}</td>
                        <td>${userBankInfo.branch || "N/A"}</td>
                        <td>${userBankInfo.branchAddress || "N/A"}</td>
                    </tr>
                `;
        } else {
          document.getElementById(
            "bankInfoBody"
          ).innerHTML = `<tr><td colspan="6" style="text-align: center;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</td></tr>`;
        }
      }

      document
        .getElementById("withdrawForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const amountToWithdraw = parseFloat(
            document.getElementById("withdraw-amount").value
          );
          const currentBalance = userProfile.THBwallet || 0;

          if (!amountToWithdraw || amountToWithdraw <= 0) {
            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
            return;
          }
          if (amountToWithdraw > currentBalance) {
            alert("‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠");
            return;
          }
          if (!userBankInfo) {
            alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô");
            return;
          }

          const isConfirmed = confirm(
            `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${amountToWithdraw} ‡∏ö‡∏≤‡∏ó‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`
          );
          if (!isConfirmed) return;

          const withdrawBtn = e.target.querySelector(".withdraw-btn");
          withdrawBtn.disabled = true;
          withdrawBtn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...";

          try {
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
            const withdrawalRequestRef = ref(database, "withdrawalRequests");
            const newRequest = {
              userId: currentUser.uid,
              userEmail: currentUser.email,
              amount: amountToWithdraw,
              bankInfo: userBankInfo, // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
              status: "pending",
              timestamp: serverTimestamp(),
            };
            await push(withdrawalRequestRef, newRequest);

            // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß

            alert("‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£");
            document.getElementById("withdraw-amount").value = "";
          } catch (error) {
            console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô:", error);
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
          } finally {
            withdrawBtn.disabled = false;
            withdrawBtn.innerText = "‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô";
          }
        });

      document.getElementById("logoutBtn").addEventListener("click", () => {
        signOut(auth).then(() => {
          window.location.href = "login.html";
        });
      });
    </script>
  </body>
</html>
